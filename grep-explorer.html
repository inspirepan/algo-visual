<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grep 原理可视化 - Boyer-Moore</title>
    <style>
        :root {
            --bg: #f7f6f1;
            --panel: #ffffff;
            --panel-2: #fbfaf6;
            --border: #e6e2d9;
            --text: #111827;
            --muted: #6b7280;
            --accent: #f97316;
            --accent-ink: #9a3412;
            --good: #15803d;
            --bad: #b91c1c;
            --info: #0ea5e9;
            --shadow: 0 22px 50px rgba(17, 24, 39, 0.08);
            --cell-w: 30px;
            --cell-h: 40px;
            --line-pad: 20px;
            --line-pad-y: 24px;
            --pattern-gap: 6px;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 24px;
            font-family: "Space Grotesk", "Soehne", "SF Pro Text", "Segoe UI", sans-serif;
            color: var(--text);
            background:
                radial-gradient(1000px 600px at 15% -10%, rgba(249, 115, 22, 0.12), transparent 60%),
                radial-gradient(900px 600px at 95% 0%, rgba(14, 165, 233, 0.12), transparent 55%),
                linear-gradient(180deg, #f7f6f1 0%, #f4f2ed 60%, #f7f6f1 100%);
            min-height: 100vh;
        }

        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(17, 24, 39, 0.35) transparent;
        }

        *::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        *::-webkit-scrollbar-track {
            background: transparent;
        }

        *::-webkit-scrollbar-thumb {
            background: rgba(17, 24, 39, 0.35);
            border-radius: 999px;
            border: 2px solid rgba(247, 246, 241, 0.9);
        }

        *::-webkit-scrollbar-thumb:hover {
            background: rgba(17, 24, 39, 0.55);
        }

        .app {
            width: 100%;
            max-width: none;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 18px 20px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 14px;
            box-shadow: var(--shadow);
        }

        .brand {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .badge {
            padding: 6px 10px;
            background: #fff3e7;
            color: var(--accent-ink);
            border: 1px solid #ffd8b3;
            border-radius: 999px;
            font-size: 0.78rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .title h1 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 650;
        }

        .title p {
            margin: 4px 0 0 0;
            color: var(--muted);
            font-size: 0.9rem;
        }

        .top-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chip {
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--panel-2);
            font-size: 0.85rem;
            color: var(--muted);
        }

        .layout {
            display: grid;
            grid-template-columns: 360px 1fr;
            gap: 20px;
            align-items: start;
        }

        .control-strip {
            display: grid;
            grid-template-columns: 1fr;
            gap: 14px;
            padding: 16px 18px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 14px;
            box-shadow: var(--shadow);
        }

        .strip-grid {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 16px;
            align-items: start;
        }

        .strip-item {
            display: grid;
            gap: 6px;
        }

        .strip-item .helper {
            font-size: 0.78rem;
            color: var(--muted);
            line-height: 1.4;
        }

        .option-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .option-pill {
            border: 1px solid var(--border);
            background: #ffffff;
            color: var(--text);
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
        }

        .option-pill:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(17, 24, 39, 0.08);
        }

        .option-pill.active {
            background: var(--text);
            color: #ffffff;
            border-color: var(--text);
        }

        .visually-hidden {
            position: absolute;
            opacity: 0;
            pointer-events: none;
            height: 0;
            width: 0;
        }

        .panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 18px;
            box-shadow: var(--shadow);
        }

        .panel.sidebar {
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-height: calc(100vh - 220px);
            overflow: auto;
        }

        .card {
            padding: 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--panel-2);
        }

        .section-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 10px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        label {
            font-size: 0.82rem;
            color: var(--muted);
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        input, textarea, select {
            background: #ffffff;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px 12px;
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.95rem;
            transition: border 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
            max-width: 100%;
        }

        input[type="range"] {
            appearance: none;
            height: 6px;
            border-radius: 999px;
            background: linear-gradient(90deg, rgba(17, 24, 39, 0.75), rgba(17, 24, 39, 0.2));
            cursor: pointer;
            padding: 0;
        }

        input[type="range"]::-webkit-slider-runnable-track {
            height: 6px;
            background: transparent;
            border-radius: 999px;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #111827;
            border: 3px solid #ffffff;
            box-shadow: 0 6px 16px rgba(17, 24, 39, 0.2);
            margin-top: -6px;
        }

        input[type="range"]::-moz-range-track {
            height: 6px;
            background: rgba(17, 24, 39, 0.2);
            border-radius: 999px;
        }

        input[type="range"]::-moz-range-progress {
            height: 6px;
            background: rgba(17, 24, 39, 0.75);
            border-radius: 999px;
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #111827;
            border: 3px solid #ffffff;
            box-shadow: 0 6px 16px rgba(17, 24, 39, 0.2);
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: rgba(249, 115, 22, 0.5);
            box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.12);
        }

        textarea {
            min-height: 140px;
            resize: vertical;
            font-family: "JetBrains Mono", "SF Mono", "Menlo", monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            min-width: 0;
        }

        .text-3lines {
            min-height: 0;
            height: calc(1.4em * 3 + 20px);
            overflow: auto;
        }

        .btn-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        button {
            background: var(--text);
            color: #ffffff;
            border: 1px solid transparent;
            padding: 9px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.18s ease, box-shadow 0.18s ease;
        }

        button:hover { transform: translateY(-1px); box-shadow: 0 6px 14px rgba(17, 24, 39, 0.12); }
        button:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; transform: none; }
        button.secondary { background: #ffffff; color: var(--text); border-color: var(--border); }
        button.ghost { background: transparent; color: var(--muted); border-color: var(--border); }

        .status-line {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            font-size: 0.9rem;
            color: var(--muted);
        }

        .status-pill {
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: #fff;
            color: var(--text);
            font-size: 0.82rem;
        }

        .viz-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 12px;
        }

        .meta-line {
            font-size: 0.85rem;
            color: var(--muted);
        }

        .legend {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 0.8rem;
            color: var(--muted);
        }

        .legend span {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .legend i {
            width: 10px;
            height: 10px;
            border-radius: 4px;
            display: inline-block;
        }

        .viz-stage {
            display: flex;
            flex-direction: column;
            gap: 14px;
            font-family: "JetBrains Mono", "SF Mono", "Menlo", monospace;
        }

        .line-display {
            background: linear-gradient(180deg, #fff 0%, #f9f8f4 100%);
            padding: var(--line-pad-y) var(--line-pad);
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            align-items: flex-start;
            overflow: hidden;
            min-height: calc((var(--line-pad-y) * 2) + (var(--cell-h) * 2) + var(--pattern-gap));
            position: relative;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
        }

        .char-box {
            width: var(--cell-w);
            height: var(--cell-h);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-bottom: 2px solid #d9d6ce;
            position: relative;
            flex-shrink: 0;
            font-size: 1.05rem;
            color: var(--text);
        }

        .char-box.match { background: rgba(21, 128, 61, 0.12); color: var(--good); font-weight: 700; }
        .char-box.mismatch { background: rgba(185, 28, 28, 0.12); color: var(--bad); }
        .char-box.active { border: 1px solid rgba(14, 165, 233, 0.5); background: rgba(14, 165, 233, 0.08); }

        .pattern-overlay {
            position: absolute;
            top: calc(var(--line-pad-y) + var(--cell-h) + var(--pattern-gap));
            left: var(--line-pad);
            display: flex;
            transition: left 0.2s cubic-bezier(0.25, 1, 0.5, 1);
            pointer-events: none;
            will-change: left;
        }

        .pattern-char {
            width: var(--cell-w);
            height: var(--cell-h);
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(249, 115, 22, 0.08);
            border: 1px solid rgba(249, 115, 22, 0.8);
            color: var(--accent-ink);
            font-weight: 700;
            box-sizing: border-box;
            flex-shrink: 0;
            font-size: 1.05rem;
        }

        .log-panel {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            font-size: 0.88rem;
            color: var(--muted);
            max-height: 180px;
            overflow-y: auto;
        }

        .log-entry { margin-bottom: 6px; }
        .log-entry.highlight { color: var(--text); font-weight: 600; }

        .grid-three {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }

        .grid-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .result-row {
            margin-top: 16px;
        }

        .output-view {
            font-family: "JetBrains Mono", "SF Mono", "Menlo", monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            color: var(--muted);
            min-height: 160px;
        }

        .output-line.found { color: var(--good); font-weight: 600; }

        .calc-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .calc-title {
            color: var(--accent-ink);
            font-weight: 700;
            font-size: 0.95rem;
        }

        .calc-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .calc-card {
            padding: 10px 12px;
            border: 1px dashed var(--border);
            border-radius: 10px;
            background: #fff;
            font-size: 0.86rem;
            color: var(--muted);
        }

        .calc-step { margin-bottom: 6px; }
        .calc-highlight { color: var(--text); background: #f5f3ee; padding: 0 4px; border-radius: 4px; }

        .gs-walk {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-family: "JetBrains Mono", "SF Mono", "Menlo", monospace;
            font-size: 0.82rem;
            line-height: 1.5;
            color: var(--text);
        }

        .gs-title {
            font-weight: 600;
            color: var(--text);
        }

        .gs-meta {
            display: grid;
            gap: 6px;
        }

        .gs-meta-line {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .gs-meta-label {
            font-size: 0.7rem;
            color: var(--muted);
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .gs-chip {
            padding: 2px 8px;
            border-radius: 8px;
            background: #f5f3ee;
            border: 1px solid var(--border);
            font-weight: 600;
        }

        .gs-list {
            display: grid;
            gap: 6px;
        }

        .gs-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: #ffffff;
        }

        .gs-label {
            font-size: 0.75rem;
            color: var(--muted);
        }

        .gs-status {
            margin-left: auto;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .gs-status.ok {
            background: rgba(21, 128, 61, 0.12);
            color: var(--good);
        }

        .gs-status.no {
            background: rgba(185, 28, 28, 0.12);
            color: var(--bad);
        }

        .gs-empty {
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px dashed var(--border);
            color: var(--muted);
            background: #ffffff;
        }

        .calc-note {
            margin-top: 6px;
            font-size: 0.8rem;
            color: var(--muted);
        }

        .table-list {
            display: grid;
            gap: 6px;
            font-family: "JetBrains Mono", "SF Mono", "Menlo", monospace;
            font-size: 0.78rem;
        }

        .table-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 6px;
            border-radius: 8px;
            background: #ffffff;
            border: 1px solid var(--border);
        }

        .prompt-box {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 14px 16px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 14px;
            box-shadow: var(--shadow);
        }

        .bmgs-panel {
            display: grid;
            gap: 14px;
        }

        .bmgs-grid {
            display: grid;
            grid-template-columns: 1fr 1.4fr;
            gap: 16px;
        }

        .bmgs-list {
            display: grid;
            gap: 8px;
        }

        .bmgs-item {
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #ffffff;
            font-family: "JetBrains Mono", "SF Mono", "Menlo", monospace;
            font-size: 0.82rem;
            text-align: left;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 8px;
            align-items: center;
            cursor: pointer;
        }

        .bmgs-item.active {
            background: #111827;
            color: #ffffff;
            border-color: #111827;
        }

        .bmgs-item-key {
            font-weight: 700;
        }

        .bmgs-item-suffix {
            color: var(--muted);
        }

        .bmgs-item.active .bmgs-item-suffix {
            color: rgba(255, 255, 255, 0.7);
        }

        .bmgs-item-val {
            font-weight: 700;
        }

        .bmgs-meta {
            display: grid;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--muted);
        }

        .bmgs-meta strong {
            color: var(--text);
        }

        .bmgs-diagram {
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px dashed var(--border);
            background: #ffffff;
            display: grid;
            gap: 6px;
            font-family: "JetBrains Mono", "SF Mono", "Menlo", monospace;
            font-size: 0.86rem;
            overflow-x: auto;
        }

        .bmgs-line {
            white-space: pre;
        }

        .bmgs-line.shift {
            color: var(--accent-ink);
            font-weight: 600;
        }

        .bmgs-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .bmgs-gap {
            width: var(--bmgs-cell, 22px);
            height: var(--bmgs-cell, 22px);
        }

        .bmgs-char {
            width: var(--bmgs-cell, 22px);
            height: var(--bmgs-cell, 22px);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: #f7f5f0;
            font-weight: 600;
            color: var(--text);
        }

        .bmgs-char.dim {
            opacity: 0.6;
        }

        .bmgs-char.mismatch {
            background: rgba(185, 28, 28, 0.12);
            color: var(--bad);
            border-color: rgba(185, 28, 28, 0.4);
        }

        .bmgs-char.shifted {
            background: rgba(249, 115, 22, 0.12);
            color: var(--accent-ink);
            border-color: rgba(249, 115, 22, 0.5);
        }

        .bmgs-char.match {
            background: rgba(21, 128, 61, 0.12);
            color: var(--good);
            border-color: rgba(21, 128, 61, 0.4);
        }

        .bmgs-shift {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bmgs-shift-bar {
            display: flex;
            align-items: center;
        }

        .bmgs-shift-cap {
            width: 2px;
            height: 12px;
            background: var(--accent-ink);
        }

        .bmgs-shift-line {
            height: 2px;
            background: var(--accent-ink);
            flex: 1;
        }

        .bmgs-shift-label {
            font-size: 0.75rem;
            color: var(--accent-ink);
            font-weight: 600;
        }

        .prompt-text {
            font-family: "JetBrains Mono", "SF Mono", "Menlo", monospace;
            font-size: 0.9rem;
            color: var(--muted);
        }

        @media (max-width: 980px) {
            .layout { grid-template-columns: 1fr; }
            .grid-three { grid-template-columns: 1fr; }
            .grid-split { grid-template-columns: 1fr; }
            .btn-row { grid-template-columns: repeat(2, 1fr); }
            .panel.sidebar { max-height: none; }
            .topbar { flex-direction: column; align-items: flex-start; }
            .prompt-box { flex-direction: column; align-items: flex-start; }
            .strip-grid { grid-template-columns: 1fr; }
            .bmgs-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<div class="app">
    <header class="topbar">
        <div class="brand">
            <span class="badge">Grep Lab</span>
            <div class="title">
                <h1>Grep 原理可视化</h1>
                <p>以 Boyer-Moore 为核心，观察坏字符与好后缀如何驱动跳跃</p>
            </div>
        </div>
        <div class="top-actions">
            <div class="chip" id="algoChip">Boyer-Moore</div>
            <div class="chip">Shift Focus</div>
        </div>
    </header>

    <section class="control-strip">
        <div class="strip-grid">
            <div class="strip-item">
                <label for="presetChoice">预设场景</label>
                <div class="option-group" id="presetGroup" role="radiogroup" aria-label="预设场景">
                    <button class="option-pill active" data-value="default" role="radio" aria-checked="true">默认：grep 简介</button>
                    <button class="option-pill" data-value="badchar" role="radio" aria-checked="false">坏字符规则大显身手</button>
                    <button class="option-pill" data-value="suffix_align" role="radio" aria-checked="false">好后缀：仅前缀对齐</button>
                    <button class="option-pill" data-value="suffix_full" role="radio" aria-checked="false">好后缀：内部完全重复</button>
                    <button class="option-pill" data-value="grep_speed" role="radio" aria-checked="false">Grep 极速体验</button>
                </div>
                <select id="presetChoice" class="visually-hidden" aria-hidden="true" tabindex="-1">
                    <option value="default">默认：grep 简介 (Naive vs BM)</option>
                    <option value="badchar">坏字符规则大显身手 (Clean Break)</option>
                    <option value="suffix_align">好后缀：仅前缀对齐 (EXAMPLE)</option>
                    <option value="suffix_full">好后缀：内部完全重复 (Tooth)</option>
                    <option value="grep_speed">Grep 极速体验 (长跳跃)</option>
                </select>
            </div>
            <div class="strip-item">
                <label for="algoChoice">算法</label>
                <div class="option-group" id="algoGroup" role="radiogroup" aria-label="算法">
                    <button class="option-pill" data-value="naive" role="radio" aria-checked="false">朴素匹配</button>
                    <button class="option-pill active" data-value="boyer" role="radio" aria-checked="true">Boyer-Moore (BC + GS)</button>
                </div>
                <select id="algoChoice" class="visually-hidden" aria-hidden="true" tabindex="-1">
                    <option value="naive">朴素匹配 (Naive Scan)</option>
                    <option value="boyer" selected>Boyer-Moore (BC + GS)</option>
                </select>
                <div id="algoDesc" class="helper">右向左比较，遇到不匹配时结合坏字符与好后缀，计算跳跃步数并取最大值。</div>
            </div>
        </div>
    </section>

    <div class="layout">
        <aside class="panel sidebar">
            <div class="card">
                <div class="section-title">实验设置</div>
                <div class="control-group">
                    <label>搜索关键词</label>
                    <input type="text" id="patternChoice" value="grep">
                </div>

                <div class="control-group">
                    <label>目标文本</label>
                    <textarea id="textChoice" class="text-3lines" rows="3">grep is a command-line utility
for searching plain-text data
sets for lines that match a
regular expression.
It was written by Ken Thompson
overnight for a task.</textarea>
                </div>
            </div>

            <div class="card">
                <div class="control-group">
                    <label>动画速度: <span id="speedVal">500ms</span></label>
                    <input type="range" id="speedChoice" min="50" max="1000" step="50" value="500" style="direction: rtl">
                </div>

                <div class="btn-row">
                    <button id="btnPlay">播放</button>
                    <button id="btnPause" class="secondary" disabled>暂停</button>
                    <button id="btnStep" class="secondary">单步 &gt;</button>
                    <button id="btnReset" class="secondary">重置</button>
                </div>

                <div class="status-line" style="margin-top: 10px;">
                    <span>状态</span>
                    <span id="statusIndicator" class="status-pill">就绪</span>
                </div>
            </div>

            <div class="card">
                <div class="section-title">运行日志</div>
                <div class="log-panel" id="logPanel">
                    <div class="log-entry">等待开始...</div>
                </div>
            </div>
        </aside>

        <main class="panel">
            <div class="viz-head">
                <div>
                    <div class="section-title">可视化演示</div>
                    <div class="meta-line">当前行 <span id="lineNum">-</span> · 当前位置 <span id="posNum">-</span></div>
                </div>
                <div class="legend">
                    <span><i style="background: rgba(21, 128, 61, 0.5);"></i>匹配</span>
                    <span><i style="background: rgba(185, 28, 28, 0.5);"></i>不匹配</span>
                    <span><i style="background: rgba(249, 115, 22, 0.4);"></i>模式词</span>
                </div>
            </div>

            <div class="viz-stage">
                <div class="line-display" id="lineDisplay"></div>
            </div>

            <div class="grid-split" style="margin-top: 16px;">
                <div class="card calc-panel" id="calcPanel">
                    <div class="calc-title">实时计算详情</div>
                    <div class="calc-grid">
                        <div class="calc-card" id="calcContent">等待运行...</div>
                        <div class="calc-card">
                            <div style="font-weight: 600; color: var(--text); margin-bottom: 6px;">好后缀推导 (前缀回退)</div>
                            <div class="gs-walk" id="gsWalk">等待运行...</div>
                            <div class="calc-note" id="gsNote"></div>
                        </div>
                    </div>
                </div>

                <div class="card" id="algoDetails" style="display:none;">
                    <div class="section-title">预处理表</div>
                    <div style="display:grid; gap: 12px;">
                        <div>
                            <div style="font-size:0.78rem; color:var(--muted); margin-bottom:6px;">坏字符表 (Bad Char)</div>
                            <div id="bcTable" class="table-list"></div>
                        </div>
                        <div>
                            <div style="font-size:0.78rem; color:var(--muted); margin-bottom:6px;">好后缀表 (Good Suffix)</div>
                            <div id="gsTable" class="table-list"></div>
                        </div>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 10px;">
                        不匹配时比较两张表的跳跃建议，取最大值。
                    </div>
                </div>
            </div>

            <div class="result-row">
                <div class="card">
                    <div class="section-title">Grep 最终输出</div>
                    <div id="outputContainer" class="output-view"></div>
                </div>
            </div>
        </main>
    </div>

    <section class="panel bmgs-panel" id="bmgsPanel">
        <div class="section-title">bmGs 含义与匹配示意</div>
        <div class="bmgs-grid">
            <div>
                <div class="bmgs-list" id="bmgsList"></div>
            </div>
            <div>
                <div class="bmgs-meta" id="bmgsMeta"></div>
                <div class="bmgs-diagram" id="bmgsDiagram"></div>
                <div class="calc-note" id="bmgsNote"></div>
            </div>
        </div>
    </section>

    <div class="prompt-box">
        <div class="prompt-text" id="promptText">请解释 Boyer-Moore 算法是如何在该文本中查找 "grep" 的。</div>
        <button style="width: auto;" id="btnCopy" class="secondary">复制提示词</button>
    </div>
</div>

<script>
    const CELL = 30;
    const PAD_LEFT = 20;

    const state = {
        pattern: "grep",
        text: "",
        algorithm: "boyer",
        delay: 500,
        lines: [],
        currentLineIdx: -1,
        steps: [],
        stepIdx: 0,
        isPlaying: false,
        isFastForwarding: false,
        timer: null
    };

    const els = {
        pattern: document.getElementById('patternChoice'),
        text: document.getElementById('textChoice'),
        algo: document.getElementById('algoChoice'),
        algoDesc: document.getElementById('algoDesc'),
        speed: document.getElementById('speedChoice'),
        speedVal: document.getElementById('speedVal'),
        btnPlay: document.getElementById('btnPlay'),
        btnPause: document.getElementById('btnPause'),
        btnStep: document.getElementById('btnStep'),
        btnReset: document.getElementById('btnReset'),
        status: document.getElementById('statusIndicator'),
        lineNum: document.getElementById('lineNum'),
        posNum: document.getElementById('posNum'),
        lineDisplay: document.getElementById('lineDisplay'),
        logPanel: document.getElementById('logPanel'),
        output: document.getElementById('outputContainer'),
        prompt: document.getElementById('promptText'),
        btnCopy: document.getElementById('btnCopy'),
        preset: document.getElementById('presetChoice'),
        presetGroup: document.getElementById('presetGroup'),
        algoDetails: document.getElementById('algoDetails'),
        algoGroup: document.getElementById('algoGroup'),
        bcTable: document.getElementById('bcTable'),
        gsTable: document.getElementById('gsTable'),
        calcContent: document.getElementById('calcContent'),
        gsWalk: document.getElementById('gsWalk'),
        gsNote: document.getElementById('gsNote'),
        algoChip: document.getElementById('algoChip'),
        bmgsPanel: document.getElementById('bmgsPanel'),
        bmgsList: document.getElementById('bmgsList'),
        bmgsMeta: document.getElementById('bmgsMeta'),
        bmgsDiagram: document.getElementById('bmgsDiagram'),
        bmgsNote: document.getElementById('bmgsNote')
    };

    function syncOptionGroup(groupEl, value) {
        if (!groupEl) return;
        const buttons = groupEl.querySelectorAll('button');
        buttons.forEach(btn => {
            const isActive = btn.dataset.value === value;
            btn.classList.toggle('active', isActive);
            btn.setAttribute('aria-checked', isActive ? 'true' : 'false');
        });
    }

    function bindOptionGroup(groupEl, selectEl) {
        if (!groupEl || !selectEl) return;
        groupEl.addEventListener('click', (event) => {
            const btn = event.target.closest('button');
            if (!btn) return;
            selectEl.value = btn.dataset.value;
            selectEl.dispatchEvent(new Event('change'));
        });
        syncOptionGroup(groupEl, selectEl.value);
    }

    const DESCRIPTIONS = {
        naive: "线性检查每个字符。简单但效率较低 O(n*m)。",
        boyer: "右向左比较，遇到不匹配时结合坏字符与好后缀，计算跳跃步数并取最大值。"
    };

    const PRESETS = {
        default: {
            p: "grep",
            t: "grep is a command-line utility\nfor searching plain-text data\nsets for lines that match a\nregular expression.\nIt was written by Ken Thompson\novernight for a task."
        },
        badchar: {
            p: "ABCDE",
            t: "XXXXAXXXXBXXXXCXXXXDXXXXE\nThis demonstrates Bad Char Rule.\nThe char 'X' is not in Pattern,\nso we skip entirely past it!"
        },
        suffix_align: {
            p: "EXAMPLE",
            t: "HERE IS A SIMPLE EXAMPLE\nmatches are rare but shifts are huge.\nThe suffix 'MPLE' matches,\nbut fails at 'I'.\nAlgorithm finds 'E' prefix matches 'E' suffix."
        },
        suffix_full: {
            p: "TOOTH",
            t: "I HAVE A TOOTHACHE TODAY.\nFirst try: matches matches 'TH'.\nFail at 'O'.\nPattern has 'TO' prefix? No.\nPattern has 'OOTH' inside? No.\nWait, look for 'OTH' inside... No.\nLook for 'OO' in 'TOOTH'? Yes!"
        },
        grep_speed: {
            p: "Z99",
            t: "Searching for a rare code in a big block.\n.....................Z99FoundIt!\nOnly checks end chars mostly.\nSkip Skip Skip!"
        }
    };

    function makeBadCharTable(pattern) {
        const table = {};
        for (let i = 0; i < pattern.length; i++) table[pattern[i]] = i;
        return table;
    }

    function makeGoodSuffixTable(pattern) {
        const m = pattern.length;
        const suff = new Array(m).fill(0);
        const bmGs = new Array(m).fill(m);

        suff[m - 1] = m;
        let g = m - 1;
        let f = 0;
        for (let i = m - 2; i >= 0; --i) {
            if (i > g && suff[i + m - 1 - f] < i - g) {
                suff[i] = suff[i + m - 1 - f];
            } else {
                if (i < g) g = i;
                f = i;
                while (g >= 0 && pattern[g] === pattern[g + m - 1 - f]) g--;
                suff[i] = f - g;
            }
        }

        let j = 0;
        for (let i = m - 1; i >= 0; --i) {
            if (suff[i] === i + 1) {
                for (; j < m - 1 - i; ++j) {
                    if (bmGs[j] === m) bmGs[j] = m - 1 - i;
                }
            }
        }

        for (let i = 0; i <= m - 2; ++i) {
            bmGs[m - 1 - suff[i]] = m - 1 - i;
        }

        return { bmGs, suff };
    }

    function renderTables(pattern) {
        els.bcTable.innerHTML = '';
        els.gsTable.innerHTML = '';

        const bc = makeBadCharTable(pattern);
        const keys = Object.keys(bc).sort();
        if (keys.length === 0) {
            els.bcTable.innerHTML = '<div class="table-row">None</div>';
        } else {
            keys.forEach(k => {
                els.bcTable.innerHTML += `<div class="table-row"><span>'${k}'</span><span>idx ${bc[k]}</span></div>`;
            });
        }

        const { bmGs } = makeGoodSuffixTable(pattern);
        bmGs.forEach((shift, idx) => {
            els.gsTable.innerHTML += `<div class="table-row"><span>@idx ${idx}</span><span style="color:var(--good)">${shift}</span></div>`;
        });
    }

    const BMGS_CELL = 22;
    const BMGS_GAP = 6;

    function buildBmgsDiagram(pattern, shift, mismatchIdx) {
        const chars = pattern.split('');
        const row1 = chars.map((ch) => ({ ch, type: 'normal' }));
        const row2 = chars.map((ch, idx) => {
            if (idx > mismatchIdx) {
                return { ch, type: 'match' };
            }
            if (idx === mismatchIdx) {
                return { ch: '?', type: 'mismatch' };
            }
            return { ch: '?', type: 'dim' };
        });
        const row3 = chars.map((ch) => ({ ch, type: 'shifted' }));
        return { row1, row2, row3, shift };
    }

    function renderBmgsDiagram(diagram) {
        els.bmgsDiagram.innerHTML = '';
        if (!diagram) return;

        const makeRow = (cells, gapCount) => {
            const row = document.createElement('div');
            row.className = 'bmgs-row';
            for (let i = 0; i < (gapCount || 0); i++) {
                const gap = document.createElement('div');
                gap.className = 'bmgs-gap';
                row.appendChild(gap);
            }
            cells.forEach((cell) => {
                const box = document.createElement('div');
                box.className = `bmgs-char${cell.type ? ' ' + cell.type : ''}`;
                box.textContent = cell.ch;
                row.appendChild(box);
            });
            return row;
        };

        els.bmgsDiagram.appendChild(makeRow(diagram.row1, 0));
        els.bmgsDiagram.appendChild(makeRow(diagram.row2, 0));
        els.bmgsDiagram.appendChild(makeRow(diagram.row3, diagram.shift));

        const shiftRow = document.createElement('div');
        shiftRow.className = 'bmgs-shift';
        const bar = document.createElement('div');
        bar.className = 'bmgs-shift-bar';
        const shiftCount = Math.max(1, diagram.shift);
        const width = shiftCount * BMGS_CELL + Math.max(shiftCount - 1, 0) * BMGS_GAP;
        bar.style.width = `${width}px`;
        const capLeft = document.createElement('span');
        capLeft.className = 'bmgs-shift-cap';
        const line = document.createElement('span');
        line.className = 'bmgs-shift-line';
        const capRight = document.createElement('span');
        capRight.className = 'bmgs-shift-cap';
        bar.appendChild(capLeft);
        bar.appendChild(line);
        bar.appendChild(capRight);
        const label = document.createElement('span');
        label.className = 'bmgs-shift-label';
        label.textContent = `shift ${diagram.shift}`;
        shiftRow.appendChild(bar);
        shiftRow.appendChild(label);
        els.bmgsDiagram.appendChild(shiftRow);
    }

    function renderBmgsMeaning(pattern) {
        if (!pattern) {
            els.bmgsList.innerHTML = '';
            els.bmgsMeta.textContent = '';
            els.bmgsDiagram.textContent = '';
            els.bmgsNote.textContent = '';
            return;
        }

        const { bmGs, suff } = makeGoodSuffixTable(pattern);
        els.bmgsList.innerHTML = '';

        const defaultIdx = pattern.length > 2 ? 1 : 0;
        const makeItem = (idx) => {
            const suffix = pattern.substring(idx + 1) || 'empty';
            const shift = bmGs[idx];
            const item = document.createElement('button');
            item.type = 'button';
            item.className = 'bmgs-item';
            item.dataset.idx = idx;

            const key = document.createElement('span');
            key.className = 'bmgs-item-key';
            key.textContent = `bmGs[${idx}]`;

            const suf = document.createElement('span');
            suf.className = 'bmgs-item-suffix';
            suf.textContent = `suffix: ${suffix}`;

            const val = document.createElement('span');
            val.className = 'bmgs-item-val';
            val.textContent = shift;

            item.appendChild(key);
            item.appendChild(suf);
            item.appendChild(val);
            return item;
        };

        bmGs.forEach((_, idx) => {
            els.bmgsList.appendChild(makeItem(idx));
        });

        const activate = (idx) => {
            const buttons = els.bmgsList.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.idx, 10) === idx);
            });

            const suffix = pattern.substring(idx + 1) || 'empty';
            const shift = bmGs[idx];
            els.bmgsMeta.textContent = '';

            const diagram = buildBmgsDiagram(pattern, shift, idx);
            renderBmgsDiagram(diagram);

            els.bmgsNote.textContent = `当前算法 ${els.algo.value === 'boyer' ? '使用' : '未使用'} bmGs[]，bmGs[${idx}] 表示在 idx ${idx} 失配时的好后缀位移。`;
        };

        els.bmgsList.onclick = (event) => {
            const btn = event.target.closest('button');
            if (!btn) return;
            activate(parseInt(btn.dataset.idx, 10));
        };

        activate(defaultIdx);
    }

    function generateSteps(text, pattern, algo) {
        let bcTable = {};
        let gsData = { bmGs: [] };

        if (algo === 'boyer') {
            bcTable = makeBadCharTable(pattern);
            gsData = makeGoodSuffixTable(pattern);
            renderTables(pattern);
            els.algoDetails.style.display = 'block';
        } else {
            els.algoDetails.style.display = 'none';
        }

        const lines = text.split('\n');
        const tasks = [];

        lines.forEach((line, lineIdx) => {
            tasks.push({ type: 'loadLine', line, lineIdx });

            let i = 0;
            let foundInLine = false;

            while (i <= line.length - pattern.length) {
                let j = 0;
                let mismatch = false;

                if (algo === 'naive') {
                    tasks.push({ type: 'align', textIdx: i });

                    for (j = 0; j < pattern.length; j++) {
                        tasks.push({ type: 'compare', textIdx: i + j, patternIdx: j });

                        if (line[i + j] !== pattern[j]) {
                            tasks.push({ type: 'mismatch', textIdx: i + j, patternIdx: j });
                            mismatch = true;
                            break;
                        } else {
                            tasks.push({ type: 'match-char', textIdx: i + j, patternIdx: j });
                        }
                    }

                    if (!mismatch) {
                        foundInLine = true;
                        tasks.push({ type: 'found', start: i, end: i + pattern.length });
                        tasks.push({ type: 'shift', amount: 1, reason: '匹配成功，继续向后扫描' });
                        i++;
                    } else {
                        tasks.push({ type: 'shift', amount: 1, reason: '不匹配，向右移动 1 格' });
                        i++;
                    }
                } else if (algo === 'boyer') {
                    tasks.push({ type: 'align', textIdx: i });
                    j = pattern.length - 1;
                    let skip = 0;
                    let mismatchIdx = -1;

                    while (j >= 0) {
                        tasks.push({ type: 'compare', textIdx: i + j, patternIdx: j });

                        if (line[i + j] !== pattern[j]) {
                            mismatchIdx = j;
                            tasks.push({ type: 'mismatch', textIdx: i + j, patternIdx: j });
                            mismatch = true;

                            const badChar = line[i + j];
                            const lastOcc = bcTable[badChar] !== undefined ? bcTable[badChar] : -1;
                            let shiftBC = mismatchIdx - lastOcc;
                            if (shiftBC < 1) shiftBC = 1;

                            const shiftGS = gsData.bmGs[mismatchIdx];
                            skip = Math.max(shiftBC, shiftGS);

                            let reason = `坏字符 '${badChar}' 建议跳 ${shiftBC} 格。`;
                            if (shiftGS > shiftBC) {
                                reason += ` 好后缀更有力，建议跳 ${shiftGS} 格。`;
                            } else {
                                reason += ` (好后缀建议 ${shiftGS} 格，未采纳)`;
                            }
                            reason += ` 最终跳 ${skip} 格`;

                            tasks.push({
                                type: 'shift',
                                amount: skip,
                                reason: reason,
                                mismatchIdx: mismatchIdx,
                                badChar: badChar,
                                pattern: pattern,
                                badCharPos: lastOcc,
                                shiftBC: shiftBC,
                                shiftGS: shiftGS,
                                finalSkip: skip,
                                suffLen: pattern.length - 1 - mismatchIdx,
                                suffStr: pattern.substring(mismatchIdx + 1)
                            });
                            break;
                        } else {
                            tasks.push({ type: 'match-char', textIdx: i + j, patternIdx: j });
                        }
                        j--;
                    }

                    if (!mismatch) {
                        foundInLine = true;
                        tasks.push({ type: 'found', start: i, end: i + pattern.length });
                        const fullMatchShift = gsData.bmGs[0] || 1;
                        tasks.push({
                            type: 'shift',
                            amount: fullMatchShift,
                            reason: `匹配成功，GS 建议跳 ${fullMatchShift} 格寻找下一个。`,
                            fullMatch: true,
                            fullMatchShift: fullMatchShift,
                            pattern: pattern
                        });
                        i += fullMatchShift;
                    } else {
                        i += skip;
                    }
                }
            }

            tasks.push({ type: 'endLine', found: foundInLine, content: line, lineIdx });
        });

        return tasks;
    }

    function renderLine(lineText) {
        els.lineDisplay.innerHTML = '';

        for (let i = 0; i < lineText.length; i++) {
            const charBox = document.createElement('div');
            charBox.className = 'char-box text-char';
            charBox.textContent = lineText[i];
            charBox.dataset.idx = i;
            els.lineDisplay.appendChild(charBox);
        }

        const patDiv = document.createElement('div');
        patDiv.className = 'pattern-overlay';
        patDiv.id = 'patternOverlay';
        patDiv.style.opacity = '0';

        for (let i = 0; i < state.pattern.length; i++) {
            const pChar = document.createElement('div');
            pChar.className = 'pattern-char';
            pChar.textContent = state.pattern[i];
            pChar.dataset.pidx = i;
            patDiv.appendChild(pChar);
        }

        els.lineDisplay.appendChild(patDiv);
    }

    function addLog(msg, type = 'info') {
        const div = document.createElement('div');
        div.className = `log-entry ${type === 'important' ? 'highlight' : ''}`;
        div.textContent = `> ${msg}`;
        els.logPanel.prepend(div);
        if (els.logPanel.children.length > 20) els.logPanel.lastChild.remove();
    }

    function addToOutput(lineIdx, content, matches) {
        if (!matches) return;
        const div = document.createElement('div');
        div.className = `output-line ${matches ? 'found' : ''}`;
        div.textContent = `${lineIdx + 1}: ${content}`;
        els.output.appendChild(div);
    }

    function buildGoodSuffixWalkthrough(pattern, mismatchIdx, shiftGS) {
        const suffix = pattern.substring(mismatchIdx + 1);
        if (!suffix) {
            return {
                html: '<div class="gs-empty">好后缀长度为 0，本轮无需推导。</div>',
                note: `预处理表: bmGs[${mismatchIdx}] = ${shiftGS}，运行时 O(1) 查表。`
            };
        }

        const items = [];
        let found = false;
        for (let k = suffix.length; k >= 1; k--) {
            const tail = suffix.slice(suffix.length - k);
            const prefix = pattern.slice(0, k);
            const ok = tail === prefix;
            items.push({ tail, prefix, ok });
            if (ok) {
                found = true;
                break;
            }
        }

        if (!found) items.push({ tail: '无可用前缀', prefix: '全跳', ok: false, fallback: true });

        const rows = items.map(item => {
            if (item.fallback) {
                return `
                    <div class="gs-row">
                        <span class="gs-label">前缀回退</span>
                        <span class="gs-chip">${item.tail}</span>
                        <span class="gs-chip">${item.prefix}</span>
                        <span class="gs-status no">全跳</span>
                    </div>
                `;
            }
            return `
                <div class="gs-row">
                    <span class="gs-chip">${item.tail}</span>
                    <span class="gs-label">对齐前缀</span>
                    <span class="gs-chip">${item.prefix}</span>
                    <span class="gs-status ${item.ok ? 'ok' : 'no'}">${item.ok ? '行' : '不行'}</span>
                </div>
            `;
        }).join('');

        const html = `
            <div class="gs-title">前缀回退检测</div>
            <div class="gs-meta">
                <div class="gs-meta-line"><span class="gs-meta-label">Pattern</span><span class="gs-chip">${pattern}</span></div>
                <div class="gs-meta-line"><span class="gs-meta-label">Suffix</span><span class="gs-chip">${suffix}</span></div>
            </div>
            <div class="gs-list">
                ${rows}
            </div>
        `;

        const internalIdx = pattern.lastIndexOf(suffix, pattern.length - 2);
        const extra = internalIdx !== -1
            ? `内部匹配: "${suffix}" 出现在 idx ${internalIdx}`
            : '内部匹配: 未找到 (回退到前缀策略)';

        return {
            html,
            note: `${extra}。预处理: suff[] -> bmGs[]，避免每次重新比对。`
        };
    }

    function buildFullMatchWalkthrough(pattern, shift) {
        if (!pattern) {
            return {
                html: '<div class="gs-empty">模式为空，无法推导。</div>',
                note: ''
            };
        }

        const items = [];
        let found = false;
        for (let k = pattern.length - 1; k >= 1; k--) {
            const tail = pattern.slice(pattern.length - k);
            const prefix = pattern.slice(0, k);
            const ok = tail === prefix;
            items.push({ tail, prefix, ok });
            if (ok) {
                found = true;
                break;
            }
        }

        if (!found) items.push({ tail: '无可用前缀', prefix: '全跳', ok: false, fallback: true });

        const rows = items.map(item => {
            if (item.fallback) {
                return `
                    <div class="gs-row">
                        <span class="gs-label">完整匹配回退</span>
                        <span class="gs-chip">${item.tail}</span>
                        <span class="gs-chip">${item.prefix}</span>
                        <span class="gs-status no">全跳</span>
                    </div>
                `;
            }
            return `
                <div class="gs-row">
                    <span class="gs-chip">${item.tail}</span>
                    <span class="gs-label">对齐前缀</span>
                    <span class="gs-chip">${item.prefix}</span>
                    <span class="gs-status ${item.ok ? 'ok' : 'no'}">${item.ok ? '行' : '不行'}</span>
                </div>
            `;
        }).join('');

        const html = `
            <div class="gs-title">完整匹配回退</div>
            <div class="gs-meta">
                <div class="gs-meta-line"><span class="gs-meta-label">Pattern</span><span class="gs-chip">${pattern}</span></div>
                <div class="gs-meta-line"><span class="gs-meta-label">Suffix</span><span class="gs-chip">${pattern}</span></div>
                <div class="gs-meta-line"><span class="gs-meta-label">Shift</span><span class="gs-chip">${shift}</span></div>
            </div>
            <div class="gs-list">
                ${rows}
            </div>
        `;

        return {
            html,
            note: '完整匹配时使用 bmGs[0]，等价于寻找最长真前缀=真后缀。'
        };
    }

    function renderCalc(task) {
        if (!task.badChar) return;

        let html = '';
        html += `<div class="calc-step"><strong>1. 坏字符规则</strong></div>`;
        html += `<div class="calc-step">坏字符: <span class="calc-highlight">'${task.badChar}'</span>，最右出现 idx: ${task.badCharPos === -1 ? '不存在' : task.badCharPos}</div>`;
        html += `<div class="calc-step">计算: ${task.mismatchIdx} - ${task.badCharPos} = ${task.shiftBC}</div>`;
        html += `<div class="calc-step">建议跳跃: <span class="calc-highlight" style="color:${task.shiftBC === task.finalSkip ? 'var(--good)' : ''}">${task.shiftBC} 格</span></div>`;

        html += `<div class="calc-step" style="margin-top:8px;"><strong>2. 好后缀规则</strong></div>`;
        if (task.suffLen > 0) {
            html += `<div class="calc-step">匹配后缀: <span class="calc-highlight">"${task.suffStr}"</span> (长度 ${task.suffLen})</div>`;
            html += `<div class="calc-step">查表: bmGs[${task.mismatchIdx}] = <span class="calc-highlight" style="color:${task.shiftGS === task.finalSkip ? 'var(--good)' : ''}">${task.shiftGS}</span></div>`;
        } else {
            html += `<div class="calc-step">后缀长度 0，本规则贡献有限。</div>`;
        }

        html += `<div class="calc-step" style="margin-top:8px; border-top:1px dashed #e6e2d9; padding-top:6px;">`;
        html += `<strong>最终结果: max(${task.shiftBC}, ${task.shiftGS}) = <span style="color:var(--accent-ink); font-size:1.05em">${task.finalSkip}</span></strong>`;
        html += `</div>`;

        els.calcContent.innerHTML = html;
        const walkthrough = buildGoodSuffixWalkthrough(task.pattern, task.mismatchIdx, task.shiftGS);
        els.gsWalk.innerHTML = walkthrough.html;
        els.gsNote.textContent = walkthrough.note;
    }

    function reset() {
        stop();
        state.stepIdx = 0;
        state.steps = [];
        state.currentLineIdx = -1;

        els.lineDisplay.innerHTML = '<div style="color:var(--muted)">准备开始...</div>';
        els.logPanel.innerHTML = '';
        els.output.innerHTML = '';
        els.status.textContent = '就绪';
        els.lineNum.textContent = '-';
        els.posNum.textContent = '-';
        els.calcContent.innerHTML = '等待运行...';
        els.gsWalk.textContent = '等待运行...';
        els.gsNote.textContent = '';

        if (els.algo.value === 'boyer' && els.pattern.value) {
            renderTables(els.pattern.value);
            els.algoDetails.style.display = 'block';
        } else {
            els.algoDetails.style.display = 'none';
        }

        renderBmgsMeaning(els.pattern.value);

        syncOptionGroup(els.presetGroup, els.preset.value);
        syncOptionGroup(els.algoGroup, els.algo.value);

        updatePrompt();
    }

    function initRun() {
        state.text = els.text.value;
        state.pattern = els.pattern.value;
        state.algorithm = els.algo.value;

        if (!state.pattern) {
            alert("请输入搜索关键词");
            return false;
        }

        state.steps = generateSteps(state.text, state.pattern, state.algorithm);
        state.stepIdx = 0;

        els.output.innerHTML = '';
        els.logPanel.innerHTML = '';

        return true;
    }

    function step() {
        if (state.stepIdx >= state.steps.length) {
            els.status.textContent = "已完成";
            stop();
            return;
        }

        const task = state.steps[state.stepIdx];
        const overlay = document.getElementById('patternOverlay');
        const textChars = document.querySelectorAll('.text-char');
        const patternChars = document.querySelectorAll('.pattern-char');

        switch (task.type) {
            case 'loadLine':
                renderLine(task.line);
                els.lineNum.textContent = task.lineIdx + 1;
                els.posNum.textContent = '-';
                addLog(`读取第 ${task.lineIdx + 1} 行: "${task.line}"`);
                state.currentLineIdx = task.lineIdx;
                break;

            case 'align':
                textChars.forEach(el => el.classList.remove('active'));
                patternChars.forEach(el => {
                    el.style.backgroundColor = 'rgba(249, 115, 22, 0.08)';
                    el.style.borderColor = 'rgba(249, 115, 22, 0.8)';
                });

                if (overlay) {
                    overlay.style.opacity = '1';
                    overlay.style.left = (PAD_LEFT + (task.textIdx * CELL)) + 'px';
                }
                els.posNum.textContent = task.textIdx;
                addLog(`对齐到索引 ${task.textIdx}`);
                break;

            case 'compare':
                if (textChars[task.textIdx]) textChars[task.textIdx].classList.add('active');
                if (patternChars[task.patternIdx]) patternChars[task.patternIdx].style.borderColor = 'var(--info)';
                break;

            case 'match-char':
                if (textChars[task.textIdx]) textChars[task.textIdx].classList.add('match');
                if (patternChars[task.patternIdx]) {
                    patternChars[task.patternIdx].style.backgroundColor = 'rgba(21, 128, 61, 0.12)';
                    patternChars[task.patternIdx].style.borderColor = 'var(--good)';
                }
                break;

            case 'mismatch':
                if (textChars[task.textIdx]) textChars[task.textIdx].classList.add('mismatch');
                if (patternChars[task.patternIdx]) {
                    patternChars[task.patternIdx].style.borderColor = 'var(--bad)';
                    patternChars[task.patternIdx].style.backgroundColor = 'rgba(185, 28, 28, 0.12)';
                }
                addLog(`索引 ${task.textIdx} 处不匹配`, 'important');
                break;

            case 'found':
                addLog(`在索引 ${task.start} 处找到匹配`, 'important');
                for (let k = task.start; k < task.end; k++) {
                    if (textChars[k]) textChars[k].classList.add('match');
                }
                break;

            case 'shift':
                addLog(task.reason);
                if (task.shiftGS !== undefined) {
                    renderCalc(task);
                } else if (task.fullMatch && state.algorithm === 'boyer') {
                    els.calcContent.innerHTML = task.reason || '匹配成功，继续向后扫描。';
                    const walkthrough = buildFullMatchWalkthrough(state.pattern, task.fullMatchShift || task.amount || 1);
                    els.gsWalk.innerHTML = walkthrough.html;
                    els.gsNote.textContent = walkthrough.note;
                } else {
                    els.calcContent.innerHTML = task.reason || '移动窗口继续比较。';
                    els.gsWalk.textContent = state.algorithm === 'boyer'
                        ? '完整匹配（或非失配场景），请查看 bmGs[0] 的位移示意。'
                        : '朴素算法不使用好后缀规则。';
                    els.gsNote.textContent = '';
                }
                break;

            case 'endLine':
                if (task.found) {
                    addLog(`第 ${task.lineIdx + 1} 行包含匹配，输出。`);
                    addToOutput(task.lineIdx, task.content, true);
                } else {
                    addLog(`第 ${task.lineIdx + 1} 行结束，无匹配。`);
                }
                if (overlay) overlay.style.opacity = '0';
                break;
        }

        state.stepIdx++;
    }

    function play() {
        if (!state.isPlaying) {
            if (state.steps.length === 0 || state.stepIdx >= state.steps.length) {
                if (!initRun()) return;
            }
            state.isPlaying = true;
            els.btnPlay.disabled = true;
            els.btnPause.disabled = false;
            els.status.textContent = "运行中";
            els.btnPlay.textContent = "继续";
            state.timer = setInterval(step, state.delay);
        }
    }

    function stop() {
        state.isPlaying = false;
        if (state.timer) {
            clearInterval(state.timer);
            clearTimeout(state.timer);
            state.timer = null;
        }
        els.btnPlay.disabled = false;
        els.btnPause.disabled = true;
        els.status.textContent = "已暂停";
        els.btnPlay.textContent = "继续";
    }

    function fastForwardLoop() {
        if (!state.isPlaying) return;
        step();
        const prevTask = state.steps[state.stepIdx - 1];
        if (!prevTask) return;
        if (state.stepIdx >= state.steps.length) return;
        if (prevTask.type === 'shift') {
            stop();
            state.isFastForwarding = false;
            els.status.textContent = "已暂停 (完成一次跳跃)";
            return;
        }
        state.timer = setTimeout(fastForwardLoop, 30);
    }

    function updateAll() {
        updatePrompt();
        els.speedVal.textContent = els.speed.value + "ms";
        state.delay = parseInt(els.speed.value, 10);
        if (state.isPlaying) {
            clearInterval(state.timer);
            state.timer = setInterval(step, state.delay);
        }
    }

    function updatePrompt() {
        const alg = els.algo.value;
        const pat = els.pattern.value;
        const algName = alg === 'naive' ? '朴素(Naive)' : 'Boyer-Moore';
        const txt = `请解释 ${algName} 算法是如何在该文本中查找 "${pat}" 的。重点讲解可视化中展示的原理，特别是不匹配和跳跃(Shift)的机制。`;
        els.prompt.textContent = txt;
        els.algoChip.textContent = alg === 'naive' ? 'Naive' : 'Boyer-Moore';
    }

    els.btnPlay.addEventListener('click', play);

    els.btnStep.addEventListener('click', () => {
        if (state.isPlaying && !state.isFastForwarding) {
            stop();
            els.status.textContent = "已暂停";
            return;
        }

        if (state.steps.length === 0) {
            if (!initRun()) return;
        }

        if (state.stepIdx >= state.steps.length) return;

        state.isFastForwarding = true;
        state.isPlaying = true;
        els.btnPlay.disabled = true;
        els.btnPause.disabled = false;
        els.status.textContent = "正在计算下一步跳跃";

        if (state.timer) {
            clearInterval(state.timer);
            clearTimeout(state.timer);
        }

        fastForwardLoop();
    });

    els.btnPause.addEventListener('click', () => {
        stop();
        els.status.textContent = "已暂停";
    });

    els.btnReset.addEventListener('click', () => {
        reset();
        els.btnPlay.textContent = "播放";
    });

    els.speed.addEventListener('input', updateAll);

    els.preset.addEventListener('change', () => {
        const key = els.preset.value;
        const data = PRESETS[key];
        if (data) {
            els.pattern.value = data.p;
            els.text.value = data.t;
            if (key !== 'default') {
                els.algo.value = 'boyer';
                els.algoDesc.textContent = DESCRIPTIONS['boyer'];
            }
            syncOptionGroup(els.presetGroup, els.preset.value);
            syncOptionGroup(els.algoGroup, els.algo.value);
            reset();
        }
    });

    els.algo.addEventListener('change', () => {
        els.algoDesc.textContent = DESCRIPTIONS[els.algo.value];
        syncOptionGroup(els.algoGroup, els.algo.value);
        reset();
    });

    els.pattern.addEventListener('input', reset);
    els.text.addEventListener('input', reset);

    els.btnCopy.addEventListener('click', () => {
        navigator.clipboard.writeText(els.prompt.textContent);
        const orig = els.btnCopy.textContent;
        els.btnCopy.textContent = "已复制";
        setTimeout(() => els.btnCopy.textContent = orig, 1500);
    });

    bindOptionGroup(els.presetGroup, els.preset);
    bindOptionGroup(els.algoGroup, els.algo);
    reset();
</script>
</body>
</html>
